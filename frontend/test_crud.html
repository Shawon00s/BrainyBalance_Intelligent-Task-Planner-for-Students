<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks CRUD Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Tasks CRUD Test</h1>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Authentication & API</h2>
            <div class="space-y-4">
                <button onclick="testLogin()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Test Login
                </button>
                <button onclick="testLoadTasks()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Test Load Tasks
                </button>
                <button onclick="testCreateTask()"
                    class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Test Create Task
                </button>
            </div>
            <div id="testResults" class="mt-4 p-4 bg-gray-50 rounded">
                <h3 class="font-semibold">Test Results:</h3>
                <ul id="resultsList" class="mt-2 space-y-1"></ul>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Tasks List</h2>
            <div id="tasksList" class="space-y-2">
                <!-- Tasks will be loaded here -->
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        function addResult(message, success = true) {
            const resultsList = document.getElementById('resultsList');
            const li = document.createElement('li');
            li.className = success ? 'text-green-600' : 'text-red-600';
            li.textContent = `${success ? '✅' : '❌'} ${message}`;
            resultsList.appendChild(li);
        }

        async function testLogin() {
            try {
                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    setToken(data.token);
                    addResult('Login successful');
                } else {
                    addResult('Login failed - Please create test user first', false);
                }
            } catch (error) {
                addResult('Login error: ' + error.message, false);
            }
        }

        async function testLoadTasks() {
            try {
                const token = getToken();
                if (!token) {
                    addResult('No token found - please login first', false);
                    return;
                }

                const response = await fetch('http://localhost:3000/api/tasks', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    addResult(`Tasks loaded: ${data.tasks.length} tasks found`);
                    displayTasks(data.tasks);
                } else {
                    addResult('Failed to load tasks', false);
                }
            } catch (error) {
                addResult('Load tasks error: ' + error.message, false);
            }
        }

        async function testCreateTask() {
            try {
                const token = getToken();
                if (!token) {
                    addResult('No token found - please login first', false);
                    return;
                }

                const taskData = {
                    title: 'Test Task ' + Date.now(),
                    description: 'This is a test task created by CRUD test',
                    deadline: new Date(Date.now() + 86400000).toISOString(), // Tomorrow
                    priority: 'medium',
                    category: 'study'
                };

                const response = await fetch('http://localhost:3000/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    const data = await response.json();
                    addResult('Task created successfully');
                    testLoadTasks(); // Reload tasks
                } else {
                    addResult('Failed to create task', false);
                }
            } catch (error) {
                addResult('Create task error: ' + error.message, false);
            }
        }

        function displayTasks(tasks) {
            const tasksList = document.getElementById('tasksList');
            if (tasks.length === 0) {
                tasksList.innerHTML = '<p class="text-gray-500">No tasks found</p>';
                return;
            }

            tasksList.innerHTML = tasks.map(task => `
                <div class="border rounded p-4 flex justify-between items-center">
                    <div>
                        <h4 class="font-semibold">${task.title}</h4>
                        <p class="text-gray-600">${task.description}</p>
                        <small class="text-gray-500">Due: ${new Date(task.deadline).toLocaleDateString()}</small>
                    </div>
                    <div class="space-x-2">
                        <button onclick="deleteTask('${task._id}')" class="text-red-600 hover:text-red-800">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function deleteTask(taskId) {
            try {
                const token = getToken();
                const response = await fetch(`http://localhost:3000/api/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    addResult('Task deleted successfully');
                    testLoadTasks(); // Reload tasks
                } else {
                    addResult('Failed to delete task', false);
                }
            } catch (error) {
                addResult('Delete task error: ' + error.message, false);
            }
        }

        // Auto-test on page load
        document.addEventListener('DOMContentLoaded', function () {
            addResult('CRUD test page loaded');
            if (getToken()) {
                addResult('Found existing token');
                testLoadTasks();
            } else {
                addResult('No token found - click "Test Login" first');
            }
        });
    </script>
</body>

</html>